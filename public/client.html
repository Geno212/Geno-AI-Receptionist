<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Sewedy Electric â€” AI Receptionist</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #050505;
      --bg-panel: rgba(20, 20, 20, 0.6);
      --brand-red: #E31E24;
      --brand-dark: #8a0f13;
      --text-main: #ffffff;
      --text-muted: #a0a0a0;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --glow-color: var(--brand-red);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      height: 100vh;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 50% 0%, #1a0505 0%, transparent 60%),
        radial-gradient(circle at 85% 90%, #0f0202 0%, transparent 50%);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    /* --- Header & Branding --- */
    .header {
      padding: 24px 40px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .brand img {
      height: 48px;
      width: auto;
      filter: drop-shadow(0 0 10px rgba(227, 30, 36, 0.3));
    }

    .brand-text {
      font-family: 'Cairo', sans-serif;
      font-weight: 800;
      font-size: 28px;
      line-height: 1;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }
    .brand-text span { color: var(--brand-red); }

    .header-controls {
      display: flex;
      gap: 16px;
    }

    .lang-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .lang-btn:hover { background: rgba(255,255,255,0.1); }

    /* --- Main Interface --- */
    .main-stage {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    /* --- AI Core Visualizer --- */
    .ai-core-container {
      position: relative;
      width: 300px;
      height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 40px;
    }

    .ai-core {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: var(--brand-red);
      box-shadow: 0 0 60px var(--brand-red);
      position: relative;
      z-index: 2;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ai-ring {
      position: absolute;
      border-radius: 50%;
      border: 2px solid var(--brand-red);
      opacity: 0.3;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.5s ease;
    }
    
    .ring-1 { width: 160px; height: 160px; border-width: 1px; }
    .ring-2 { width: 220px; height: 220px; border-width: 1px; opacity: 0.1; }
    .ring-3 { width: 280px; height: 280px; border-width: 1px; opacity: 0.05; }

    /* States */
    .state-listening .ai-core {
      background: #ffffff;
      box-shadow: 0 0 40px rgba(255,255,255,0.5);
      transform: scale(0.9);
    }
    .state-listening .ring-1 { border-color: #fff; width: 150px; height: 150px; animation: pulse-ring 2s infinite; }
    
    .state-speaking .ai-core {
      background: var(--brand-red);
      box-shadow: 0 0 80px var(--brand-red), inset 0 0 20px #fff;
      animation: pulse-core 1.5s infinite alternate;
    }
    .state-speaking .ring-1 { width: 180px; height: 180px; opacity: 0.5; animation: spin 10s linear infinite; border-top-color: transparent; }
    .state-speaking .ring-2 { width: 240px; height: 240px; opacity: 0.3; animation: spin 15s linear infinite reverse; border-bottom-color: transparent; }

    @keyframes pulse-core { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    @keyframes pulse-ring { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; } 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; } }
    @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

    /* --- Status Text --- */
    .status-display {
      text-align: center;
      margin-bottom: 40px;
      height: 60px;
    }
    .status-title {
      font-size: 24px;
      font-weight: 300;
      letter-spacing: 1px;
      margin: 0 0 8px 0;
      opacity: 0.9;
    }
    .status-sub {
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* --- Controls --- */
    .control-bar {
      display: flex;
      gap: 20px;
      background: var(--bg-panel);
      padding: 12px;
      border-radius: 24px;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      z-index: 10;
    }

    .btn {
      border: none;
      padding: 16px 32px;
      border-radius: 16px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--brand-red);
      color: white;
      box-shadow: 0 4px 20px rgba(227, 30, 36, 0.4);
    }
    .btn-primary:hover { background: #ff2a30; transform: translateY(-2px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }

    .btn-danger {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid var(--glass-border);
    }
    .btn-danger:hover { background: rgba(255, 255, 255, 0.2); }
    .btn-danger:disabled { opacity: 0.3; cursor: not-allowed; }

    .lang-select {
      background: transparent;
      color: white;
      border: none;
      font-size: 16px;
      padding: 0 16px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    .lang-select option { background: #111; }

    /* --- Chat Log (Overlay) --- */
    .chat-log {
      position: absolute;
      right: 40px;
      top: 120px;
      bottom: 120px;
      width: 350px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-right: 10px;
      mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 10%, black 90%, transparent);
    }
    
    .msg {
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 14px;
      line-height: 1.5;
      max-width: 90%;
      animation: fade-in 0.3s ease forwards;
    }
    .msg.user {
      align-self: flex-end;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      border-bottom-right-radius: 2px;
    }
    .msg.ai {
      align-self: flex-start;
      background: rgba(227, 30, 36, 0.1);
      border: 1px solid rgba(227, 30, 36, 0.3);
      color: var(--text-main);
      border-bottom-left-radius: 2px;
    }
    
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }

    /* Responsive */
    @media (max-width: 900px) {
      .chat-log {
        position: relative;
        width: 100%;
        height: 200px;
        top: auto; bottom: auto;
        mask-image: none; -webkit-mask-image: none;
        margin-top: 20px;
      }
      .header { padding: 16px; }
      .brand-text { font-size: 20px; }
      .ai-core-container { width: 200px; height: 200px; }
      .ai-core { width: 80px; height: 80px; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="brand">
      <img src="logo.webp" alt="El Sewedy Electric Logo">
      <div class="brand-text"><span>ELSEWEDY</span> ELECTRIC</div>
    </div>
    <div class="header-controls">
      <button id="langToggle" class="lang-btn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>
  </header>

  <main class="main-stage">
    
    <div class="ai-core-container" id="aiContainer">
      <div class="ai-ring ring-3"></div>
      <div class="ai-ring ring-2"></div>
      <div class="ai-ring ring-1"></div>
      <div class="ai-core"></div>
    </div>

    <div class="status-display">
      <h2 class="status-title" id="ui-title">AI Receptionist</h2>
      <div class="status-sub" id="status">READY TO CONNECT</div>
    </div>

    <div class="control-bar">
      <select id="langSelect" class="lang-select">
        <option value="ar-EG">ðŸ‡ªðŸ‡¬ Arabic</option>
        <option value="en-US">ðŸ‡ºðŸ‡¸ English</option>
        <option value="fr-FR">ðŸ‡«ðŸ‡· French</option>
        <option value="de-DE">ðŸ‡©ðŸ‡ª German</option>
        <option value="es-ES">ðŸ‡ªðŸ‡¸ Spanish</option>
        <option value="it-IT">ðŸ‡®ðŸ‡¹ Italian</option>
        <option value="ja-JP">ðŸ‡¯ðŸ‡µ Japanese</option>
      </select>
      
      <button id="btnCall" class="btn btn-primary">
        <span class="icon">ðŸ“ž</span> <span id="btnCallText">Start Call</span>
      </button>
      
      <button id="btnHangup" class="btn btn-danger" disabled>
        <span class="icon">âœ•</span>
      </button>
    </div>

    <div class="chat-log" id="chatLog">
      <!-- Messages will appear here -->
    </div>

  </main>

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const chatLog = $('#chatLog');
    const aiContainer = $('#aiContainer');
    
    // RTL Logic & Localization
    const translations = {
      "ar-EG": {
        "title": "Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø°ÙƒÙŠ",
        "status_ready": "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„",
        "status_connecting": "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...",
        "status_incall": "Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©",
        "status_listening": "Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ...",
        "status_speaking": "ÙŠØªØ­Ø¯Ø«...",
        "btn_call": "Ø§ØªØµØ§Ù„",
        "lang_toggle": "English"
      },
      "en-US": {
        "title": "AI Receptionist",
        "status_ready": "READY TO CONNECT",
        "status_connecting": "CONNECTING...",
        "status_incall": "CALL ACTIVE",
        "status_listening": "LISTENING...",
        "status_speaking": "SPEAKING...",
        "btn_call": "Start Call",
        "lang_toggle": "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
      }
    };

    const langSelect = $('#langSelect');
    const langToggle = $('#langToggle');
    
    function updateTexts(lang) {
      const t = translations[lang] || translations["en-US"];
      $('#ui-title').textContent = t.title;
      $('#btnCallText').textContent = t.btn_call;
      
      // Update Toggle Button Text
      if (lang.startsWith('ar')) {
        langToggle.textContent = "English";
        langToggle.style.fontFamily = "Inter";
      } else {
        langToggle.textContent = "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
        langToggle.style.fontFamily = "Cairo";
      }
      
      // Update status text if idle
      if(!ws || ws.readyState !== WebSocket.OPEN) {
         $('#status').textContent = t.status_ready;
      }
    }

    langSelect.onchange = () => {
      const lang = langSelect.value;
      document.documentElement.dir = lang.startsWith('ar') ? 'rtl' : 'ltr';
      updateTexts(lang);
      if (isRecording) { stopSTT(); startSTT(); }
    };

    langToggle.onclick = () => {
      if (langSelect.value === 'ar-EG') {
        langSelect.value = 'en-US';
      } else {
        langSelect.value = 'ar-EG';
      }
      langSelect.onchange();
    };

    function addChatMessage(text, type) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    function setStatus(key) {
      const lang = langSelect.value;
      const t = translations[lang] || translations["en-US"];
      const text = t[`status_${key}`] || key;
      $('#status').textContent = text;
    }

    function setVisualizerState(state) {
      aiContainer.classList.remove('state-listening', 'state-speaking');
      if(state) aiContainer.classList.add(`state-${state}`);
    }

    // ===== Direct WebSocket Setup =====
    let ws;
    let recognition;
    let isRecording = false;
    let isAiSpeaking = false;
    
    // MediaSource Audio Player
    let mediaSource;
    let audioEl;
    let sourceBuffer;
    let audioQueue = [];
    let isEOS = false;

    async function startCall(){
      if(isRecording) return;
      setStatus('connecting');
      
      // 1. Connect WebSocket
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/client-ws`);
      ws.binaryType = 'arraybuffer';

      ws.onopen = async () => {
        addChatMessage("Connected to server", "system");
        setStatus('incall');
        $('#btnCall').disabled = true;
        $('#btnHangup').disabled = false;
        
        // 2. Start STT
        startSTT();
      };

      ws.onmessage = async (event) => {
        if (event.data instanceof ArrayBuffer) {
          if (!isAiSpeaking) {
            isAiSpeaking = true;
            stopSTT(); // Stop listening to avoid echo
            initAudioPlayer();
            setVisualizerState('speaking');
            setStatus('speaking');
          }
          feedAudio(event.data);
        } else {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'tts_end') {
              finalizeAudio();
            }
          } catch(e) {}
        }
      };

      ws.onclose = () => {
        addChatMessage("Call ended", "system");
        stopSTT();
        setStatus('ready');
        setVisualizerState(null);
        $('#btnCall').disabled = false;
        $('#btnHangup').disabled = true;
        if (audioEl) { audioEl.pause(); audioEl = null; }
      };
    }


    function initAudioPlayer() {
        if (audioEl) { 
            audioEl.pause();
            audioEl.removeAttribute('src');
            audioEl.load();
        }
        if (mediaSource && mediaSource.readyState === 'open') {
            try { mediaSource.endOfStream(); } catch(e){}
        }
        
        mediaSource = new MediaSource();
        audioEl = new Audio();
        audioEl.src = URL.createObjectURL(mediaSource);
        audioQueue = [];
        isEOS = false;
        sourceBuffer = null;
        
        mediaSource.addEventListener('sourceopen', function(e) {
            const ms = e.target;
            if (ms.readyState !== 'open') return;
            if (ms.sourceBuffers.length > 0) return;
            
            if (MediaSource.isTypeSupported('audio/mpeg')) {
                try {
                    sourceBuffer = ms.addSourceBuffer('audio/mpeg');
                    sourceBuffer.mode = 'sequence';
                    sourceBuffer.addEventListener('updateend', pushNextChunk);
                } catch (err) {
                    console.error('Audio Error: ' + err.message);
                }
            }
        });
        
        audioEl.onended = () => {
            isAiSpeaking = false;
            setVisualizerState('listening'); // Back to listening
            setStatus('listening');
            startSTT(); // Resume listening
        };
        
        audioEl.play().catch(e => console.log("Tap page to enable audio"));
    }

    function feedAudio(chunk) {
        audioQueue.push(chunk);
        pushNextChunk();
    }

    function pushNextChunk() {
        if (!sourceBuffer || sourceBuffer.updating) return;
        
        if (audioQueue.length > 0) {
            try {
                sourceBuffer.appendBuffer(audioQueue.shift());
            } catch (e) { console.error("Buffer append error", e); }
        } else if (isEOS && mediaSource.readyState === 'open') {
            mediaSource.endOfStream();
        }
    }
    
    function finalizeAudio() {
        isEOS = true;
        pushNextChunk();
    }

    let silenceTimer;

    function startSTT() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        addChatMessage("Browser does not support Speech Recognition", "system");
        return;
      }
      recognition = new SpeechRecognition();
      recognition.lang = $('#langSelect').value || 'ar-EG';
      recognition.continuous = true;
      recognition.interimResults = true; 

      recognition.onstart = () => {
        setVisualizerState('listening');
        setStatus('listening');
      };

      recognition.onresult = (event) => {
        clearTimeout(silenceTimer);
        
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript;
        const isFinal = event.results[last].isFinal;

        if (isFinal) {
            commitSpeech(text);
        } else {
            // Wait 1.5s of silence to assume speech is done
            silenceTimer = setTimeout(() => {
                commitSpeech(text);
            }, 1500);
        }
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech' && e.error !== 'aborted') console.log('STT Error: ' + e.error);
      };

      recognition.onend = () => {
        if (isRecording) recognition.start(); 
      };

      recognition.start();
      isRecording = true;
    }

    function commitSpeech(text) {
        if (!text || !text.trim()) return;
        clearTimeout(silenceTimer);
        addChatMessage(text, "user");
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'text', text: text }));
        }
        
        stopSTT();
    }

    function stopSTT() {
      isRecording = false;
      clearTimeout(silenceTimer);
      if (recognition) recognition.stop();
    }

    function hangup(){ 
      if(ws) ws.close(); 
    }

    // Buttons & Shortcuts
    $('#btnCall').onclick = startCall;
    $('#btnHangup').onclick = hangup;
    
    window.addEventListener('keydown', (e)=>{
      if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT')) return;
      if(e.key.toLowerCase()==='c') $('#btnCall').click();
      if(e.key.toLowerCase()==='h') $('#btnHangup').click();
    });

    // Mic permission hint
    navigator.mediaDevices?.getUserMedia({ audio: true }).then(stream=>{
      stream.getTracks().forEach(t=>t.stop());
    }).catch(()=>{ addChatMessage("Please allow microphone access", "system"); });

  </script>
</body>
</html>
