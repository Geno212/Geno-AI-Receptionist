<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>El Sewedy Electric â€” AI Receptionist</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;800&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #050505;
      --bg-panel: rgba(20, 20, 20, 0.6);
      --brand-red: #E31E24;
      --brand-dark: #8a0f13;
      --text-main: #ffffff;
      --text-muted: #a0a0a0;
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-highlight: rgba(255, 255, 255, 0.05);
      --glow-color: var(--brand-red);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      height: 100vh; /* Fallback */
      height: 100dvh;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 50% 0%, #1a0505 0%, transparent 60%),
        radial-gradient(circle at 85% 90%, #0f0202 0%, transparent 50%);
      color: var(--text-main);
      font-family: 'Inter', sans-serif;
      overflow: hidden; /* Prevent body scroll */
      display: flex;
      flex-direction: column;
    }

    /* --- Header & Branding --- */
    .header {
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
      flex-shrink: 0; /* Prevent header from shrinking */
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand img {
      height: 40px;
      width: auto;
      filter: drop-shadow(0 0 10px rgba(227, 30, 36, 0.3));
    }

    .brand-text {
      font-family: 'Cairo', sans-serif;
      font-weight: 800;
      font-size: 24px;
      line-height: 1;
      letter-spacing: -0.02em;
      text-transform: uppercase;
    }
    .brand-text span { color: var(--brand-red); }

    .header-controls {
      display: flex;
      gap: 12px;
    }

    .lang-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--glass-border);
      color: var(--text-main);
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
      font-family: 'Cairo', sans-serif;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }
    .lang-btn:hover { background: rgba(255,255,255,0.1); }

    /* --- Main Interface --- */
    .main-stage {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden; /* Contain children */
      width: 100%;
    }

    /* --- AI Core Visualizer --- */
    .ai-core-container {
      position: relative;
      width: 280px;
      height: 280px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 20px;
      flex-shrink: 0;
    }

    .ai-core {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--brand-red);
      box-shadow: 0 0 60px var(--brand-red);
      position: relative;
      z-index: 2;
      transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .ai-ring {
      position: absolute;
      border-radius: 50%;
      border: 2px solid var(--brand-red);
      opacity: 0.3;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      transition: all 0.5s ease;
    }
    
    .ring-1 { width: 140px; height: 140px; border-width: 1px; }
    .ring-2 { width: 200px; height: 200px; border-width: 1px; opacity: 0.1; }
    .ring-3 { width: 260px; height: 260px; border-width: 1px; opacity: 0.05; }

    /* States */
    .state-listening .ai-core {
      background: #ffffff;
      box-shadow: 0 0 40px rgba(255,255,255,0.5);
      transform: scale(0.9);
    }
    .state-listening .ring-1 { border-color: #fff; width: 130px; height: 130px; animation: pulse-ring 2s infinite; }
    
    .state-speaking .ai-core {
      background: var(--brand-red);
      box-shadow: 0 0 80px var(--brand-red), inset 0 0 20px #fff;
      animation: pulse-core 1.5s infinite alternate;
    }
    .state-speaking .ring-1 { width: 160px; height: 160px; opacity: 0.5; animation: spin 10s linear infinite; border-top-color: transparent; }
    .state-speaking .ring-2 { width: 220px; height: 220px; opacity: 0.3; animation: spin 15s linear infinite reverse; border-bottom-color: transparent; }

    @keyframes pulse-core { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    @keyframes pulse-ring { 0% { transform: translate(-50%, -50%) scale(1); opacity: 0.3; } 100% { transform: translate(-50%, -50%) scale(1.2); opacity: 0; } }
    @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

    /* --- Status Text --- */
    .status-display {
      text-align: center;
      margin-bottom: 20px;
      height: 50px;
      flex-shrink: 0;
    }
    .status-title {
      font-size: 20px;
      font-weight: 300;
      letter-spacing: 1px;
      margin: 0 0 4px 0;
      opacity: 0.9;
    }
    .status-sub {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 2px;
    }

    /* --- Controls --- */
    .control-bar {
      display: flex;
      gap: 16px;
      background: var(--bg-panel);
      padding: 10px;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      backdrop-filter: blur(20px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.4);
      z-index: 10;
      margin-bottom: 40px; /* Default desktop margin */
    }

    .btn {
      border: none;
      padding: 14px 28px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: 'Inter', sans-serif;
    }

    .btn-primary {
      background: var(--brand-red);
      color: white;
      box-shadow: 0 4px 20px rgba(227, 30, 36, 0.4);
    }
    .btn-primary:hover { background: #ff2a30; transform: translateY(-2px); }
    .btn-primary:active { transform: translateY(0); }
    .btn-primary:disabled { background: #333; color: #666; box-shadow: none; cursor: not-allowed; }

    .btn-danger {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border: 1px solid var(--glass-border);
    }
    .btn-danger:hover { background: rgba(255, 255, 255, 0.2); }
    .btn-danger:disabled { opacity: 0.3; cursor: not-allowed; }

    .lang-select {
      background: transparent;
      color: white;
      border: none;
      font-size: 15px;
      padding: 0 12px;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
    }
    .lang-select option { background: #111; }

    /* --- Chat Log (Overlay) --- */
    .chat-log {
      position: absolute;
      right: 40px;
      top: 100px;
      bottom: 100px;
      width: 320px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding-right: 8px;
      mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
      -webkit-mask-image: linear-gradient(to bottom, transparent, black 5%, black 95%, transparent);
    }
    
    .msg {
      padding: 10px 14px;
      border-radius: 10px;
      font-size: 13px;
      line-height: 1.4;
      max-width: 90%;
      animation: fade-in 0.3s ease forwards;
    }
    .msg.user {
      align-self: flex-end;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid var(--glass-border);
      color: var(--text-muted);
      border-bottom-right-radius: 2px;
    }
    .msg.ai {
      align-self: flex-start;
      background: rgba(227, 30, 36, 0.1);
      border: 1px solid rgba(227, 30, 36, 0.3);
      color: var(--text-main);
      border-bottom-left-radius: 2px;
    }
    
    @keyframes fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 2px; }

    /* Responsive */
    @media (max-width: 900px) {
      .chat-log {
        position: relative;
        width: 100%;
        height: auto;
        flex: 1;
        top: auto; bottom: auto;
        right: auto;
        mask-image: none; -webkit-mask-image: none;
        margin-top: 10px;
        padding: 0 20px;
        margin-bottom: 20px;
      }
      .header { padding: 16px; }
      .brand-text { font-size: 20px; }
      .ai-core-container { width: 220px; height: 220px; margin-bottom: 10px; }
      .ai-core { width: 80px; height: 80px; }
      .ring-1 { width: 120px; height: 120px; }
      .ring-2 { width: 160px; height: 160px; }
      .ring-3 { width: 200px; height: 200px; }
      
      .control-bar { margin-bottom: 20px; }
    }

    @media (max-width: 600px) {
      .header { padding: 12px 16px; }
      .brand img { height: 32px; }
      .brand-text { font-size: 18px; }
      
      .main-stage { 
        justify-content: flex-start; 
        padding-top: 20px; 
        padding-bottom: 100px; /* Space for fixed control bar */
        overflow-y: auto; /* Allow scrolling if content is tall */
      }
      
      .ai-core-container { 
        width: 180px; height: 180px; 
        margin-bottom: 10px; 
        flex-shrink: 0; 
      }
      .ai-core { width: 60px; height: 60px; }
      .ring-1 { width: 100px; height: 100px; }
      .ring-2 { width: 130px; height: 130px; }
      .ring-3 { width: 160px; height: 160px; }

      .control-bar {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        width: calc(100% - 32px); /* Full width minus padding */
        max-width: 400px;
        justify-content: space-between;
        padding: 8px 12px;
        gap: 8px;
        margin-bottom: 0;
        background: rgba(20, 20, 20, 0.85); /* More opaque for readability */
      }
      
      .btn { padding: 10px 16px; font-size: 13px; }
      .lang-select { width: auto; font-size: 13px; padding: 0 4px; }
      
      .chat-log {
        height: auto;
        flex: none; /* Don't flex, just take content height */
        width: 100%;
        margin-bottom: 0;
        padding-bottom: 20px;
      }
      
      .status-display { margin-bottom: 10px; height: auto; }
      .status-title { font-size: 18px; }
      .status-sub { font-size: 11px; }
    }
  </style>
</head>
<body>

  <header class="header">
    <div class="brand">
      <img src="logo.webp" alt="El Sewedy Electric Logo">
      <div class="brand-text"><span>ELSEWEDY</span> ELECTRIC</div>
    </div>
    <div class="header-controls">
      <button id="langToggle" class="lang-btn">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    </div>
  </header>

  <main class="main-stage">
    
    <div class="ai-core-container" id="aiContainer">
      <div class="ai-ring ring-3"></div>
      <div class="ai-ring ring-2"></div>
      <div class="ai-ring ring-1"></div>
      <div class="ai-core"></div>
    </div>

    <div class="status-display">
      <h2 class="status-title" id="ui-title">AI Receptionist</h2>
      <div class="status-sub" id="status">READY TO CONNECT</div>
    </div>

    <div class="control-bar">
      <select id="langSelect" class="lang-select">
        <option value="ar-EG">ðŸ‡ªðŸ‡¬ Arabic</option>
        <option value="en-US">ðŸ‡ºðŸ‡¸ English</option>
        <option value="fr-FR">ðŸ‡«ðŸ‡· French</option>
        <option value="de-DE">ðŸ‡©ðŸ‡ª German</option>
        <option value="es-ES">ðŸ‡ªðŸ‡¸ Spanish</option>
        <option value="it-IT">ðŸ‡®ðŸ‡¹ Italian</option>
        <option value="ja-JP">ðŸ‡¯ðŸ‡µ Japanese</option>
      </select>
      
      <button id="btnCall" class="btn btn-primary">
        <span class="icon">ðŸ“ž</span> <span id="btnCallText">Start Call</span>
      </button>
      
      <button id="btnHangup" class="btn btn-danger" disabled>
        <span class="icon">âœ•</span>
      </button>
    </div>

    <div class="chat-log" id="chatLog">
      <!-- Messages will appear here -->
    </div>

  </main>

  <script>
    // ===== Utilities =====
    const $ = sel => document.querySelector(sel);
    const chatLog = $('#chatLog');
    const aiContainer = $('#aiContainer');
    
    // RTL Logic & Localization
    const translations = {
      "ar-EG": {
        "title": "Ù…ÙˆØ¸Ù Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø°ÙƒÙŠ",
        "status_ready": "Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§ØªØµØ§Ù„",
        "status_connecting": "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...",
        "status_incall": "Ù…ÙƒØ§Ù„Ù…Ø© Ø¬Ø§Ø±ÙŠØ©",
        "status_listening": "Ø£Ø³ØªÙ…Ø¹ Ø¥Ù„ÙŠÙƒ...",
        "status_speaking": "ÙŠØªØ­Ø¯Ø«...",
        "btn_call": "Ø§ØªØµØ§Ù„",
        "lang_toggle": "English"
      },
      "en-US": {
        "title": "AI Receptionist",
        "status_ready": "READY TO CONNECT",
        "status_connecting": "CONNECTING...",
        "status_incall": "CALL ACTIVE",
        "status_listening": "LISTENING...",
        "status_speaking": "SPEAKING...",
        "btn_call": "Start Call",
        "lang_toggle": "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©"
      }
    };

    const langSelect = $('#langSelect');
    const langToggle = $('#langToggle');
    
    function updateTexts(lang) {
      const t = translations[lang] || translations["en-US"];
      $('#ui-title').textContent = t.title;
      $('#btnCallText').textContent = t.btn_call;
      
      // Update Toggle Button Text
      if (lang.startsWith('ar')) {
        langToggle.textContent = "English";
        langToggle.style.fontFamily = "Inter";
      } else {
        langToggle.textContent = "Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©";
        langToggle.style.fontFamily = "Cairo";
      }
      
      // Update status text if idle
      if(!ws || ws.readyState !== WebSocket.OPEN) {
         $('#status').textContent = t.status_ready;
      }
    }

    langSelect.onchange = () => {
      const lang = langSelect.value;
      document.documentElement.dir = lang.startsWith('ar') ? 'rtl' : 'ltr';
      updateTexts(lang);
      if (isRecording) { stopSTT(); startSTT(); }
    };

    langToggle.onclick = () => {
      if (langSelect.value === 'ar-EG') {
        langSelect.value = 'en-US';
      } else {
        langSelect.value = 'ar-EG';
      }
      langSelect.onchange();
    };

    function addChatMessage(text, type) {
      const div = document.createElement('div');
      div.className = `msg ${type}`;
      div.textContent = text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }
    
    function setStatus(key) {
      const lang = langSelect.value;
      const t = translations[lang] || translations["en-US"];
      const text = t[`status_${key}`] || key;
      $('#status').textContent = text;
    }

    function setVisualizerState(state) {
      aiContainer.classList.remove('state-listening', 'state-speaking');
      if(state) aiContainer.classList.add(`state-${state}`);
    }

    // ===== Direct WebSocket Setup =====
    let ws;
    let recognition;
    let isRecording = false;
    let isAiSpeaking = false;
    let isCommitting = false;
    
    // Audio Context & PCM Player
    let audioCtx;
    let nextStartTime = 0;
    const SAMPLE_RATE = 24000; // Must match server output_format=pcm_24000
    let pcmBufferQueue = new Uint8Array(0); // Buffer for split frames

    async function startCall(){
      if(isRecording) return;
      setStatus('connecting');
      
      // Initialize Audio Context on user gesture
      if (!audioCtx) {
        // Do not force sampleRate in constructor, let browser decide (usually 44100 or 48000)
        // We will resample via createBuffer
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        await audioCtx.resume();
      }
      nextStartTime = 0;
      pcmBufferQueue = new Uint8Array(0);

      // 1. Connect WebSocket
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      ws = new WebSocket(`${protocol}//${window.location.host}/client-ws`);
      ws.binaryType = 'arraybuffer';

      ws.onopen = async () => {
        addChatMessage("Connected to server", "system");
        setStatus('incall');
        $('#btnCall').disabled = true;
        $('#btnHangup').disabled = false;
        
        // 2. Start STT
        startSTT();
      };

      ws.onmessage = async (event) => {
        if (event.data instanceof ArrayBuffer) {
          if (!isAiSpeaking) {
            isAiSpeaking = true;
            stopSTT(); // Stop listening to avoid echo
            setVisualizerState('speaking');
            setStatus('speaking');
            // Reset timing for new utterance
            nextStartTime = audioCtx.currentTime + 0.05; 
          }
          playPCMChunk(event.data);
        } else {
          try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'tts_end') {
              // We don't need to do anything special for PCM end, 
              // just wait for the queue to finish playing?
              // We can estimate when it finishes based on nextStartTime
              const remaining = nextStartTime - audioCtx.currentTime;
              if (remaining > 0) {
                setTimeout(() => {
                   if(isAiSpeaking) {
                     isAiSpeaking = false;
                     setVisualizerState('listening');
                     setStatus('listening');
                     startSTT();
                   }
                }, remaining * 1000);
              } else {
                 isAiSpeaking = false;
                 setVisualizerState('listening');
                 setStatus('listening');
                 startSTT();
              }
            }
          } catch(e) {}
        }
      };

      ws.onclose = () => {
        addChatMessage("Call ended", "system");
        stopSTT();
        setStatus('ready');
        setVisualizerState(null);
        $('#btnCall').disabled = false;
        $('#btnHangup').disabled = true;
        if (audioCtx) audioCtx.close().then(() => audioCtx = null);
      };
    }

    function playPCMChunk(arrayBuffer) {
        if (!audioCtx) return;
        
        // Append new data to queue
        const newChunk = new Uint8Array(arrayBuffer);
        const combined = new Uint8Array(pcmBufferQueue.length + newChunk.length);
        combined.set(pcmBufferQueue);
        combined.set(newChunk, pcmBufferQueue.length);
        
        // Process only complete 16-bit samples (multiples of 2)
        const remainder = combined.length % 2;
        const processableLength = combined.length - remainder;
        
        if (processableLength === 0) {
            pcmBufferQueue = combined;
            return;
        }
        
        const processBuffer = combined.slice(0, processableLength);
        pcmBufferQueue = combined.slice(processableLength); // Keep remainder for next chunk
        
        // Convert Int16Array (raw PCM) to Float32Array
        const int16Data = new Int16Array(processBuffer.buffer);
        const float32Data = new Float32Array(int16Data.length);
        
        for (let i = 0; i < int16Data.length; i++) {
            // Normalize to [-1.0, 1.0]
            float32Data[i] = int16Data[i] / 32768.0;
        }

        const buffer = audioCtx.createBuffer(1, float32Data.length, SAMPLE_RATE);
        buffer.getChannelData(0).set(float32Data);

        const source = audioCtx.createBufferSource();
        source.buffer = buffer;
        source.connect(audioCtx.destination);

        // Schedule playback
        if (nextStartTime < audioCtx.currentTime) {
            nextStartTime = audioCtx.currentTime;
        }
        
        source.start(nextStartTime);
        nextStartTime += buffer.duration;
    }

    let silenceTimer;

    function startSTT() {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SpeechRecognition) {
        addChatMessage("Browser does not support Speech Recognition", "system");
        return;
      }
      isCommitting = false; // Reset commit flag for new turn
      recognition = new SpeechRecognition();
      recognition.lang = $('#langSelect').value || 'ar-EG';
      recognition.continuous = true;
      recognition.interimResults = true; 

      recognition.onstart = () => {
        setVisualizerState('listening');
        setStatus('listening');
      };

      recognition.onresult = (event) => {
        clearTimeout(silenceTimer);
        
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript;
        const isFinal = event.results[last].isFinal;

        if (isFinal) {
            commitSpeech(text);
        } else {
            // Wait 1.5s of silence to assume speech is done
            silenceTimer = setTimeout(() => {
                commitSpeech(text);
            }, 1500);
        }
      };

      recognition.onerror = (e) => {
        if (e.error !== 'no-speech' && e.error !== 'aborted') console.log('STT Error: ' + e.error);
      };

      recognition.onend = () => {
        if (isRecording) recognition.start(); 
      };

      recognition.start();
      isRecording = true;
    }

    function commitSpeech(text) {
        if (isCommitting) return;
        if (!text || !text.trim()) return;
        
        isCommitting = true;
        clearTimeout(silenceTimer);
        addChatMessage(text, "user");
        
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ type: 'text', text: text }));
        }
        
        stopSTT();
    }

    function stopSTT() {
      isRecording = false;
      clearTimeout(silenceTimer);
      if (recognition) recognition.stop();
    }

    function hangup(){ 
      if(ws) ws.close(); 
    }

    // Buttons & Shortcuts
    $('#btnCall').onclick = startCall;
    $('#btnHangup').onclick = hangup;
    
    window.addEventListener('keydown', (e)=>{
      if(e.target && (e.target.tagName==='INPUT' || e.target.tagName==='SELECT')) return;
      if(e.key.toLowerCase()==='c') $('#btnCall').click();
      if(e.key.toLowerCase()==='h') $('#btnHangup').click();
    });

    // Mic permission hint
    navigator.mediaDevices?.getUserMedia({ audio: true }).then(stream=>{
      stream.getTracks().forEach(t=>t.stop());
    }).catch(()=>{ addChatMessage("Please allow microphone access", "system"); });

  </script>
</body>
</html>
